---
title: Pancreatic endocrinogenesis
execute: 
  freeze: true
  eval: true
  warning: false
  error: false
  cache: true
toc: true
number-sections: true
highlight-style: gruvbox
csl: ../../bibstyle.csl
lightbox: auto
format:
  html:
    html-math-method: katex
  ipynb: default
---

```{python}
#| label: enable-autoreload
#| code-fold: true
#| output: false
%load_ext autoreload
%autoreload 2 
from IPython.display import Image, display
``` 

Please see the [guide on interactive results review](/guides/interactive/interactive.qmd) for a 
general review of how to download and review results. Here we use the same 
approach without any of the explanatory text to retrieve model results to 
generate plots for model selection and evaluation.

## Get results

::: {#wrn-downsampled-data .callout-warning collapse=true title="Downsampled Data"}
In this notebook we illustrate how to download and review results using
unrealistic downsampled data. Therefore, this notebook should not be taken
to represent the results of applying the model to real data.
:::


### Identify results of interest

```{python}
# | label: get-workflow-io
from pyrovelocity.io.cluster import get_remote_task_results

(
    model1_postprocessing_inputs,
    model1_postprocessing_outputs,
) = get_remote_task_results(
    execution_id="pyrovelocity-py311-defaul-fe20d09-dev-pzh-17b5092261c84e8695a",
    task_id="f26c1pjy-0-dn1-0-dn3",
)

(
    model2_postprocessing_inputs,
    model2_postprocessing_outputs,
) = get_remote_task_results(
    execution_id="pyrovelocity-py311-defaul-fe20d09-dev-pzh-17b5092261c84e8695a",
    task_id="f26c1pjy-0-dn1-0-dn6",
)
```

### Download results

```{python}
# | label: download-outputs
from pyrovelocity.io.gcs import download_blob_from_uri

model1_pyrovelocity_data = download_blob_from_uri(
    blob_uri=model1_postprocessing_outputs.o0.pyrovelocity_data.path,
    download_filename_prefix=f"{model1_postprocessing_inputs.training_outputs.data_model}",
)
model1_postprocessed_data = download_blob_from_uri(
    blob_uri=model1_postprocessing_outputs.o0.postprocessed_data.path,
    download_filename_prefix=f"{model1_postprocessing_inputs.training_outputs.data_model}",
)

model2_pyrovelocity_data = download_blob_from_uri(
    blob_uri=model2_postprocessing_outputs.o0.pyrovelocity_data.path,
    download_filename_prefix=f"{model2_postprocessing_inputs.training_outputs.data_model}",
)
model2_postprocessed_data = download_blob_from_uri(
    blob_uri=model2_postprocessing_outputs.o0.postprocessed_data.path,
    download_filename_prefix=f"{model2_postprocessing_inputs.training_outputs.data_model}",
)
```


## Analyze results

### Model 1

#### Load data

```{python}
# | label: model1-load-postprocessed-data
# | output: true
import scanpy as sc
from pyrovelocity.utils import print_anndata

adata = sc.read(model1_postprocessed_data)
print_anndata(adata)
```

```{python}
# | label: model1-load-posterior-samples
# | output: true
from pyrovelocity.utils import pretty_print_dict
from pyrovelocity.io import CompressedPickle

posterior_samples = CompressedPickle.load(model1_pyrovelocity_data)
pretty_print_dict(posterior_samples)
```

#### Extract results of interest

```{python}
# | label: model1-extract-gene-selection
from pyrovelocity.analysis.analyze import pareto_frontier_genes

volcano_data = posterior_samples["gene_ranking"]
number_of_marker_genes = min(
    max(int(len(volcano_data) * 0.1), 4), 6, len(volcano_data)
)
putative_marker_genes = pareto_frontier_genes(
    volcano_data, number_of_marker_genes
)
```

#### Generate plots

```{python}
# | label: model1-generate-gene-selection-summary-plot
# | output: false
from pyrovelocity.plots import plot_gene_selection_summary

vector_field_basis = model1_postprocessing_inputs.preprocess_data_args.vector_field_basis
cell_state = model1_postprocessing_inputs.preprocess_data_args.cell_state

plot_gene_selection_summary(
    adata=adata,
    posterior_samples=posterior_samples,
    basis=vector_field_basis,
    cell_state=cell_state,
    plot_name="gene_selection_summary_plot.pdf",
    selected_genes=putative_marker_genes,
    show_marginal_histograms=False,
)
```

```{python}
# | label: model1-show-gene-selection-summary-plot
# | code-fold: true
# | output: true
display(Image(filename=f"gene_selection_summary_plot.pdf.png"))
```

### Model 2

#### Load data

```{python}
# | label: model2-load-postprocessed-data
# | output: true
import scanpy as sc
from pyrovelocity.utils import print_anndata

adata = sc.read(model2_postprocessed_data)
print_anndata(adata)
```

```{python}
# | label: model2-load-posterior-samples
# | output: true
from pyrovelocity.utils import pretty_print_dict
from pyrovelocity.io import CompressedPickle

posterior_samples = CompressedPickle.load(model2_pyrovelocity_data)
pretty_print_dict(posterior_samples)
```

#### Extract results of interest

```{python}
# | label: model2-extract-gene-selection
from pyrovelocity.analysis.analyze import pareto_frontier_genes

volcano_data = posterior_samples["gene_ranking"]
number_of_marker_genes = min(
    max(int(len(volcano_data) * 0.1), 4), 6, len(volcano_data)
)
putative_marker_genes = pareto_frontier_genes(
    volcano_data, number_of_marker_genes
)
```

#### Generate plots

```{python}
# | label: model2-generate-gene-selection-summary-plot
# | output: false
from pyrovelocity.plots import plot_gene_selection_summary

vector_field_basis = model2_postprocessing_inputs.preprocess_data_args.vector_field_basis
cell_state = model2_postprocessing_inputs.preprocess_data_args.cell_state

plot_gene_selection_summary(
    adata=adata,
    posterior_samples=posterior_samples,
    basis=vector_field_basis,
    cell_state=cell_state,
    plot_name="gene_selection_summary_plot.pdf",
    selected_genes=putative_marker_genes,
    show_marginal_histograms=False,
)
```

```{python}
# | label: model2-show-gene-selection-summary-plot
# | code-fold: true
# | output: true
display(Image(filename=f"gene_selection_summary_plot.pdf.png"))
```
